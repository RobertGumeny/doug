# doug Go Port — Full Backlog
# Usage: Copy one epic at a time into tasks.yaml before each run.
# Each epic depends on all prior epics being DONE.

---
epic:
  id: "EPIC-1"
  name: "Scaffold & Core Types"
  tasks:
    - id: "EPIC-1-001"
      type: "feature"
      status: "DONE"
      description: "Verify the project scaffold is correct and production-ready. The repo has been pre-scaffolded with cobra, stub subcommands, GoReleaser config, GitHub Actions workflows, and a Makefile. This task does not add new code — it audits the scaffold against the checklist below and fixes anything that is missing or incorrect."
      acceptance_criteria:
        - "go.mod exists with the correct module path and go 1.22; go.sum exists with cobra entries"
        - "go build ./... produces a binary with no errors"
        - "go test ./... passes"
        - "go vet ./... reports no issues"
        - "./doug --help lists run and init subcommands"
        - "./doug run and ./doug init both print 'not implemented' and exit 0"
        - "./doug --version prints doug v0.0.1"
        - ".goreleaser.yaml targets linux/amd64, linux/arm64, darwin/amd64, darwin/arm64, windows/amd64"
        - "ci.yml runs go test ./... and go vet ./... on ubuntu-latest and macos-latest"
        - "release.yml triggers GoReleaser on v* tag pushes"
        - "Makefile has build, test, lint, and release-dry targets"
        - "internal/ directory exists (empty is fine)"
        - "integration/ directory exists (empty is fine)"

    - id: "EPIC-1-002"
      type: "feature"
      status: "DONE"
      description: "Create internal/types/types.go defining all structs used by the orchestrator: ProjectState (current_epic, active_task, next_task, kb_enabled, metrics), Tasks (epic, task list), SessionResult (outcome, changelog_entry, dependencies_added), and all nested types. Include YAML struct tags matching the existing Bash orchestrator schema."
      acceptance_criteria:
        - "All structs have correct YAML tags matching the Bash orchestrator field names (snake_case)"
        - "SessionResult has exactly three fields: Outcome, ChangelogEntry, DependenciesAdded"
        - "Task status values (TODO, IN_PROGRESS, DONE, BLOCKED) and outcome values (SUCCESS, BUG, FAILURE, EPIC_COMPLETE) are defined as typed string constants, not bare strings"
        - "Task type values (feature, bugfix, documentation, manual_review) are defined as typed string constants"
        - "UserDefined vs Synthetic task distinction is encoded as a first-class boolean or enum on the Task struct or as a helper function"
        - "A table-driven unit test verifies round-trip marshal/unmarshal for ProjectState and Tasks using gopkg.in/yaml.v3"

    - id: "EPIC-1-003"
      type: "feature"
      status: "DONE"
      description: "Create internal/state/state.go with LoadProjectState, SaveProjectState, LoadTasks, SaveTasks. Add gopkg.in/yaml.v3. Writes must be atomic: write to a .tmp file first, then os.Rename to the final path to prevent partial writes from corrupting state."
      acceptance_criteria:
        - "SaveProjectState writes to a .tmp file first, then os.Rename to the final path"
        - "LoadProjectState returns a typed error distinguishing 'file not found' from 'parse error'"
        - "LoadTasks and SaveTasks follow the same atomic write pattern"
        - "Unit tests use t.TempDir() and verify that a load after save produces an identical struct"
        - "go.sum is updated with the yaml.v3 entry and committed"

    - id: "EPIC-1-004"
      type: "feature"
      status: "DONE"
      description: "Create internal/config/config.go with OrchestratorConfig struct (agent_command, build_system, max_retries, max_iterations, kb_enabled) and LoadConfig. Config reads from doug.yaml in the project root. All fields have sane defaults (agent_command: claude, max_retries: 5, max_iterations: 20, kb_enabled: true). Include DetectBuildSystem() that checks for go.mod and package.json."
      acceptance_criteria:
        - "A missing config file returns defaults, not an error"
        - "A partial config file fills missing fields with defaults"
        - "DetectBuildSystem() returns 'go' if go.mod exists, 'npm' if package.json exists, 'go' if both exist (go takes precedence)"
        - "CLI flags passed via cobra override config file values (highest precedence)"
        - "Unit tests cover: missing file (defaults), partial file (defaults for missing fields), detection precedence"
---
epic:
  id: "EPIC-2"
  name: "Infrastructure"
  tasks:
    - id: "EPIC-2-001"
      type: "feature"
      status: "DONE"
      description: "Create internal/log/log.go with Info, Success, Warning, Error, Fatal, and Section functions. Use ANSI escape codes for color with no external dependency. Fatal calls os.Exit(1). Section prints a unicode box-draw separator matching the Bash orchestrator's visual style."
      acceptance_criteria:
        - "All six functions implemented: Info (white), Success (green), Warning (yellow), Error (red), Fatal (red + exit 1), Section (cyan box-draw separator)"
        - "Output format matches [LEVEL] message convention from the Bash orchestrator"
        - "The package compiles with no external dependencies beyond stdlib"
        - "Fatal logs the error message before calling os.Exit(1)"

    - id: "EPIC-2-002"
      type: "feature"
      status: "DONE"
      description: "Create internal/build/build.go with the BuildSystem interface (Install() error, Build() error, Test() error, IsInitialized() bool). Implement GoBuildSystem using exec.Command (never sh -c or eval). Go commands: go mod download, go build ./..., go test ./.... Build and test output is captured and returned as part of the error on failure (last 50 lines). IsInitialized checks for go.sum."
      acceptance_criteria:
        - "BuildSystem interface is defined with the four methods"
        - "GoBuildSystem wraps each command in exec.Cmd with Dir set to the project root — no shell eval"
        - "Build() and Test() return errors that include the last 50 lines of output on failure"
        - "IsInitialized() returns true if and only if go.sum exists in the project root"
        - "Unit tests mock the filesystem check for IsInitialized"

    - id: "EPIC-2-003"
      type: "feature"
      status: "DONE"
      description: "Implement NpmBuildSystem in internal/build/npm.go. Commands: npm install, npm run build, npm run test. Before running npm run test, check if the test script key exists in package.json. Handle the NO_TESTS_CONFIGURED sentinel in test output. IsInitialized checks for node_modules. Add NewBuildSystem(buildSystemType, projectRoot string) factory function."
      acceptance_criteria:
        - "NpmBuildSystem implements the BuildSystem interface"
        - "Test() reads package.json to verify the test script key exists before running; returns nil (skip) if not configured"
        - "Test() returns nil (skip) if output contains NO_TESTS_CONFIGURED"
        - "IsInitialized() returns true if and only if node_modules/ directory exists"
        - "NewBuildSystem factory returns GoBuildSystem for 'go', NpmBuildSystem for 'npm', and a descriptive error for unknown types"

    - id: "EPIC-2-004"
      type: "feature"
      status: "DONE"
      description: 'Create internal/git/git.go with EnsureEpicBranch(branchName, projectRoot string), RollbackChanges(projectRoot string, protectedPaths []string), and Commit(message, projectRoot string). Use exec.Command("git", ...) throughout — no go-git library. RollbackChanges must preserve state files (project-state.yaml, tasks.yaml) across reset --hard using the temp-copy-then-restore pattern.'
      acceptance_criteria:
        - "EnsureEpicBranch: if already on branch → no-op; if branch exists → checkout; if new → create with checkout -b"
        - "RollbackChanges copies protected files to t.TempDir before git reset --hard HEAD, restores them after, then runs git clean -fd with exclude args for logs/, docs/kb/, .env, *.backup"
        - "Commit runs git add -A then git commit; returns a descriptive non-fatal error if nothing to commit rather than treating it as fatal"
        - "All functions accept projectRoot string as a parameter — no package-level globals"
        - "All git commands use exec.Command with an explicit args slice, never sh -c"
---
epic:
  id: "EPIC-3"
  name: "State Management"
  tasks:
    - id: "EPIC-3-001"
      type: "feature"
      status: "TODO"
      description: "Create internal/orchestrator/bootstrap.go. Implement BootstrapFromTasks(state *types.ProjectState, tasks *types.Tasks) (initializes epic/task pointers on first run), NeedsKBSynthesis(state, tasks) bool, and IsEpicAlreadyComplete(state, tasks) bool. The dead epic-complete task type from the Bash orchestrator is NOT ported — IsEpicAlreadyComplete checks task completion status directly."
      acceptance_criteria:
        - "BootstrapFromTasks is a no-op if state.CurrentEpic.ID is already set"
        - "On first run, populates current_epic (id, name, branch_name, started_at), active_task (first task), and next_task (second task or empty)"
        - "NeedsKBSynthesis returns false if any tasks remain TODO/IN_PROGRESS, if kb_enabled is false, or if active task is already documentation type"
        - "IsEpicAlreadyComplete returns true only when all user-defined tasks are DONE and kb_enabled is false, or kb synthesis is also complete"
        - "Unit tests cover: fresh state, already-bootstrapped state, single-task epic, kb_enabled=false"

    - id: "EPIC-3-002"
      type: "feature"
      status: "TODO"
      description: "Create internal/orchestrator/taskpointers.go. Implement InitializeTaskPointers(state, tasks), AdvanceToNextTask(state, tasks) bool, FindNextActiveTask(tasks) (id, taskType string), IncrementAttempts(state), and UpdateTaskStatus(tasks, id, status)."
      acceptance_criteria:
        - "InitializeTaskPointers selects IN_PROGRESS task first, then TODO; sets synthetic KB_UPDATE task if no feature tasks remain and kb_enabled is true"
        - "AdvanceToNextTask promotes next_task to active_task, finds the new next_task (or empty), returns false if no more tasks remain"
        - "IncrementAttempts increments state.ActiveTask.Attempts in memory (caller is responsible for SaveState)"
        - "UpdateTaskStatus finds the task by ID in tasks.Tasks and updates its Status; returns an error if ID not found"
        - "Unit tests cover: advance through 3 tasks, advance from last task (no next), KB synthesis trigger, UpdateTaskStatus with unknown ID"

    - id: "EPIC-3-003"
      type: "feature"
      status: "TODO"
      description: "Create internal/orchestrator/validation.go. Implement ValidateYAMLStructure(state, tasks) error and ValidateStateSync(state, tasks) (ValidationResult, error). Apply the tiered recovery philosophy: unambiguous recovery is silent, recoverable-with-risk emits a warning, ambiguous cases return an error."
      acceptance_criteria:
        - "ValidateYAMLStructure returns an error for missing required fields (current_epic.id, active_task.type, active_task.id) and invalid task status enum values"
        - "ValidateStateSync silently corrects state when active_task.ID is not found in tasks.yaml AND there is exactly one TODO/IN_PROGRESS task to redirect to"
        - "ValidateStateSync returns a warning-level ValidationResult (not error) when it auto-corrects, so the caller can log it"
        - "ValidateStateSync returns an error when the mismatched ID belongs to a synthetic task type (bugfix, documentation) — no auto-correct for synthetic tasks"
        - "ValidationResult type distinguishes: OK, AutoCorrected (with description), and Fatal"

    - id: "EPIC-3-004"
      type: "feature"
      status: "TODO"
      description: "Create internal/metrics/metrics.go and internal/changelog/changelog.go. Metrics: RecordTaskMetrics, UpdateMetricTotals, PrintEpicSummary. Changelog: UpdateChangelog(path, entry, taskType string) reads the file, finds the correct section header, splices in the new entry, and writes back. Includes deduplication check before inserting."
      acceptance_criteria:
        - "RecordTaskMetrics appends to state.Metrics.Tasks and calls UpdateMetricTotals; metric errors are non-fatal (logged as warning, do not fail the task)"
        - "PrintEpicSummary prints a box-draw table with total tasks, total time (formatted as h/m/s), and average time per task"
        - "UpdateChangelog returns a non-fatal error (logged as warning) if the section header is not found, rather than crashing"
        - "UpdateChangelog is idempotent: inserting the same entry twice results in only one entry in the file"
        - "UpdateChangelog uses pure Go string manipulation — no sed, no awk, no exec.Command"
---
epic:
  id: "EPIC-4"
  name: "Agent Layer"
  tasks:
    - id: "EPIC-4-001"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/session.go. Implement CreateSessionFile(logsDir, epic, taskID string, attempt int) (string, error): copies the embedded session results template to logs/sessions/{epic}/session-{taskID}_attempt-{attempt}.md and pre-fills the task_id field. Session file path construction and template hydration are the only responsibilities of this function."
      acceptance_criteria:
        - "Session file path follows the exact pattern logs/sessions/{epic}/session-{taskID}_attempt-{attempt}.md"
        - "The template task_id field is pre-filled with the actual task ID at creation time"
        - "CreateSessionFile creates the parent directory if it does not exist"
        - "Unit test verifies file creation, task_id injection, and that the rest of the template structure is preserved"

    - id: "EPIC-4-002"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/activetask.go. Implement WriteActiveTask(config ActiveTaskConfig) error which writes logs/ACTIVE_TASK.md with: task ID, task type, skill instructions (loaded from skills-config.yaml mapping), session file path, and bug context section (bugfix tasks only). Implement GetSkillForTaskType(taskType, configPath string) (string, error) reading from skills-config.yaml with hardcoded fallback defaults."
      acceptance_criteria:
        - "ACTIVE_TASK.md is always written to logs/ACTIVE_TASK.md — overwritten each iteration, never archived"
        - "Skill instructions are loaded from the resolved skill file path in skills-config.yaml, or from hardcoded fallback content if the file is missing"
        - "For bugfix tasks, the bug context section reads from logs/ACTIVE_BUG.md; if the file is missing, the section is omitted gracefully with a warning log"
        - "For documentation (synthetic) tasks, the task type is preserved correctly as 'documentation' in the written file"
        - "GetSkillForTaskType returns an error for unknown task types with no fallback"

    - id: "EPIC-4-003"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/invoke.go. Implement RunAgent(agentCommand, projectRoot string) (time.Duration, error): parse agentCommand by whitespace into executable + args slice (no sh -c), create exec.Cmd with Dir=projectRoot, pipe Stdout and Stderr to the parent process in real time, record wall-clock duration. Block until the agent exits."
      acceptance_criteria:
        - "Agent command is split by whitespace into executable + args slice — no sh -c or shell wrapping of any kind"
        - "cmd.Stdout and cmd.Stderr are wired to the parent process's os.Stdout and os.Stderr so agent output is visible live"
        - "Duration is measured from immediately before cmd.Start() to cmd.Wait() completion"
        - "A non-zero exit code from the agent returns an error with the exit code included in the message"
        - "An empty or whitespace-only agentCommand returns a validation error before attempting exec"

    - id: "EPIC-4-004"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/parse.go. Implement ParseSessionResult(filePath string) (*types.SessionResult, error): read the session file, extract YAML frontmatter between the first and second --- delimiter lines, unmarshal into SessionResult, validate that Outcome is one of the four valid values. No awk, no yq — pure Go string scanning and yaml.Unmarshal."
      acceptance_criteria:
        - "Frontmatter extraction handles both Windows (CRLF) and Unix (LF) line endings"
        - "Returns a typed error distinguishing: file not found, no frontmatter found, missing outcome field, invalid outcome value"
        - "All four valid outcomes (SUCCESS, BUG, FAILURE, EPIC_COMPLETE) are accepted; anything else is an error"
        - "Extra fields in the frontmatter beyond the three consumed fields are silently ignored"
        - "Table-driven unit tests cover: valid file, missing ---, empty outcome, unknown outcome value, extra fields"
---
epic:
  id: "EPIC-5"
  name: "Handlers & Main Loop"
  pr_checklist:
    - "Review cmd/run.go end-to-end for behavioral correctness against the Bash orchestrator spec — go build passes but loop correctness requires a human read"
  tasks:
    - id: "EPIC-5-001"
      type: "feature"
      status: "TODO"
      description: "Define LoopContext struct in internal/orchestrator/context.go carrying all per-iteration state: TaskID, TaskType, Attempts, CurrentEpic, SessionResult, Config, BuildSystem, ProjectRoot, TaskStartTime. Then create internal/handlers/success.go implementing HandleSuccess(ctx *LoopContext) (SuccessResult, error). Sequence: install new deps (if dependencies_added set) → verify build → verify tests → record metrics → update changelog → mark task DONE → commit → advance to next task. Return type distinguishes Continue, Retry, and EpicComplete outcomes."
      acceptance_criteria:
        - "LoopContext struct is defined with all fields listed in the description; used by all handler functions in this epic"
        - "HandleSuccess returns Retry (not error) when build or test verification fails; rollback is called before returning Retry"
        - "git commit failure is non-fatal: log the error, return Retry"
        - "KB synthesis is triggered (active_task set to documentation/KB_UPDATE) when all feature tasks are DONE and kb_enabled is true"
        - "Documentation task SUCCESS sets current_epic.completed_at and returns EpicComplete"

    - id: "EPIC-5-002"
      type: "feature"
      status: "TODO"
      description: "Create internal/handlers/failure.go implementing HandleFailure(ctx *LoopContext) error. Sequence: rollback → record metrics → check attempt count → if attempts >= max_retries: archive failure report from logs/ACTIVE_FAILURE.md, mark task BLOCKED, set active_task to manual_review, return fatal error. Otherwise: log retry warning, return nil."
      acceptance_criteria:
        - "Failure archive reads from logs/ACTIVE_FAILURE.md — not a subdirectory (this is the CI-2 fix applied by design)"
        - "If logs/ACTIVE_FAILURE.md does not exist, archiving is skipped with a warning log — non-fatal"
        - "Archive destination is logs/failures/{epic}/failure-{taskID}.md"
        - "At MAX_RETRIES, the returned error message includes the task ID and retry count"
        - "Below MAX_RETRIES, returns nil so the main loop continues to the next iteration"

    - id: "EPIC-5-003"
      type: "feature"
      status: "TODO"
      description: "Create internal/handlers/bug.go implementing HandleBug(ctx *LoopContext) error. Sequence: check for nested bug (if task_type == bugfix → Tier 3 fatal, do NOT rollback first) → rollback → record metrics → generate bug ID (BUG-{taskID}) → archive bug report from logs/ACTIVE_BUG.md → set active_task to bugfix → set next_task to interrupted task. For synthetic interrupted tasks (documentation), use the current TaskType string directly rather than querying tasks.yaml."
      acceptance_criteria:
        - "Nested bug check runs BEFORE rollback; if task type is already bugfix, return a fatal-level error immediately"
        - "Bug archive reads from logs/ACTIVE_BUG.md — not a subdirectory (this is the CI-1 fix applied by design)"
        - "next_task.type is correctly set for both user-defined tasks (look up in tasks.yaml by ID) and synthetic tasks (use the current TaskType string directly — fixes CI-5)"
        - "Bug ID is generated as BUG-{taskID}, e.g. BUG-EPIC-1-003"
        - "If logs/ACTIVE_BUG.md does not exist, the bug is still scheduled — the archive step is skipped with a warning"

    - id: "EPIC-5-004"
      type: "feature"
      status: "TODO"
      description: "Create internal/handlers/epic.go implementing HandleEpicComplete(ctx *LoopContext) error: print summary, git add -A, git commit with epic finalization message, print completion banner. Commit failure is a Tier 3 exit — return an explicit error, do NOT proceed to exit 0 (fixes CI-6). Also create internal/orchestrator/startup.go with CheckDependencies(config) and EnsureProjectReady(buildSys, config)."
      acceptance_criteria:
        - "HandleEpicComplete returns an explicit non-nil error if git commit fails; callers must check and surface this error — never silently swallow it"
        - "CheckDependencies verifies that the agent_command binary, git, and the language toolchain (go or npm) are all on PATH; returns a descriptive error listing what is missing"
        - "EnsureProjectReady skips pre-flight build/test when IsInitialized() returns false; emits a visible warning log in this case"
        - "EnsureProjectReady pre-flight failure returns a fatal-level error that includes the last 50 lines of build/test output"

    - id: "EPIC-5-005"
      type: "feature"
      status: "TODO"
      description: "Implement the full run command in cmd/run.go. Wire together the complete orchestration loop: load config → CheckDependencies → load state and tasks → BootstrapFromTasks → IsEpicAlreadyComplete check → EnsureProjectReady → ValidateYAMLStructure → EnsureEpicBranch → InitializeTaskPointers → ValidateStateSync → main loop (IncrementAttempts → CreateSessionFile → WriteActiveTask → RunAgent → ParseSessionResult → dispatch to handler). Handle max iterations exit."
      acceptance_criteria:
        - "go build ./... produces a working binary; ./doug run --help prints usage"
        - "Loop exits with code 0 on max iterations reached, epic complete, and clean early exit (all tasks already DONE)"
        - "Loop exits with code 1 only on fatal errors: corrupt state, nested bug, blocked task, HandleEpicComplete error"
        - "HandleEpicComplete error is checked and surfaced as exit code 1 with a clear message — never exit 0"
        - "IncrementAttempts is called at the START of each iteration before any agent invocation (matching Bash orchestrator behavior)"
---
epic:
  id: "EPIC-6"
  name: "Init Subcommand & Templates"
  tasks:
    - id: "EPIC-6-001"
      type: "feature"
      status: "TODO"
      description: "Implement cmd/init.go. The init command: detects build system (or accepts --build-system flag), generates doug.yaml with sensible defaults and inline comments explaining each field, generates a starter tasks.yaml with an example epic, generates a PRD.md template. Does not overwrite existing files without --force."
      acceptance_criteria:
        - "Running doug init in a directory with go.mod generates a config with build_system: go pre-filled"
        - "Generated doug.yaml has inline YAML comments explaining each field"
        - "Generated tasks.yaml has a complete example epic with two tasks and all required fields (id, type, status, description, acceptance_criteria)"
        - "init exits with non-zero and a clear message if project-state.yaml or tasks.yaml already exists; --force flag overwrites"

    - id: "EPIC-6-002"
      type: "feature"
      status: "TODO"
      description: "Create internal/templates/templates.go using //go:embed. Embed: CLAUDE.md, AGENTS.md, SESSION_RESULTS_TEMPLATE.md, BUG_REPORT_TEMPLATE.md, FAILURE_REPORT_TEMPLATE.md, and the skills/ directory. The init command copies these into the target project. Session file creation in the agent layer reads from the embedded template, not from disk."
      acceptance_criteria:
        - "All template files are embedded at compile time using //go:embed; no runtime disk path dependency for templates"
        - "init copies all templates to the project's .claude/ directory (skills) and project root (CLAUDE.md, AGENTS.md)"
        - "CreateSessionFile uses the embedded session results template — update Epic 4 implementation if needed"
        - "go build ./... passes; go test ./... verifies the embed FS contains all expected file paths"
        - "SESSION_RESULTS_TEMPLATE.md embedded here has exactly three frontmatter fields: outcome, changelog_entry, dependencies_added — no estimated_tokens, no duration_seconds"

    - id: "EPIC-6-003"
      type: "feature"
      status: "TODO"
      description: "Write integration/smoke_test.go with a test that exercises the full orchestrator loop end-to-end using a mock agent. The mock agent is a small Go binary or shell script that reads its invocation context and writes a valid session file with outcome: SUCCESS. Verifies a two-task epic runs to completion, updates task statuses correctly, and produces two commits."
      acceptance_criteria:
        - "Test creates a real git repository in t.TempDir() with tasks.yaml, project-state.yaml, and go.mod"
        - "Mock agent writes a minimal valid session result file: outcome SUCCESS, no changelog entry, no deps"
        - "After the loop runs with max_iterations=5, both tasks are DONE in tasks.yaml"
        - "git log in the test repo shows exactly two task commits with messages matching feat: EPIC-X-001 and feat: EPIC-X-002 patterns"
        - "Test is runnable with go test ./integration/... and completes in under 30 seconds"

    - id: "EPIC-6-004"
      type: "feature"
      status: "TODO"
      description: "Final automated QA pass. Run the full test suite and verify the binary is production-ready. All checks must be performed programmatically. Confirm go test ./... passes, the smoke test passes, the binary builds cleanly, doug init produces a valid scaffold, and go vet ./... reports no issues."
      acceptance_criteria:
        - "go test ./... passes with zero failures across all packages"
        - "go test ./integration/... passes: two-task epic with mock agent completes, both tasks DONE, two commits in git log"
        - "go build ./... produces a binary with no errors"
        - "go vet ./... reports no issues"
        - "doug init run in a fresh temp directory produces doug.yaml, tasks.yaml, PRD.md, CLAUDE.md, and AGENTS.md"
        - "Embedded templates verified: embed FS contains SESSION_RESULTS_TEMPLATE.md, BUG_REPORT_TEMPLATE.md, FAILURE_REPORT_TEMPLATE.md, and at least one skill file"
