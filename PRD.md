# PRD: doug Go Port

**Version**: 1.0  
**Status**: Approved — Ready for Epic Execution  
**Binary Name**: `doug`  
**Module Path**: `github.com/[org]/doug`  
**Target**: `v0.4.0`

---

## Problem

The current `doug` orchestrator is implemented in Bash. It works, but it has structural limits that block the move from personal tool to shared tool:

- **Not cross-platform.** `sed`, `awk`, `yq`, and `eval` are POSIX/macOS-specific. Windows users cannot run it.
- **No type safety.** YAML state mutations are scattered `yq eval -i` calls with no validation. A single malformed write can corrupt state silently.
- **No test coverage.** Bash scripts are not unit-testable. The orchestrator has zero automated tests.
- **Not distributable.** There is no installer, no release binary, and no onboarding path for new users.

---

## Goal

Produce a compiled, cross-platform Go binary that is functionally equivalent to the `v0.3.0` Bash orchestrator, is fully unit-tested, and ships with an `init` subcommand for zero-friction project onboarding.

**The Go port is not a feature addition.** It is a faithful translation of validated Bash logic into a language that supports the requirements above.

---

## Non-Goals

- No new orchestrator features beyond what `v0.3.0` provides
- No TUI (bubbletea/lipgloss deferred to a future version)
- No Python build system support (community contribution path)
- No agent sandboxing (document the trust boundary explicitly; enforce by instruction only)
- No token tracking (removed in a prior migration; `claude-stats` handles this externally)

---

## Architecture

### Guiding Principle

Lightweight, cross-platform, agent-agnostic Go binary. Works with any agent that can read a file and write a file. Ships with defaults for Claude Code.

### Three-Layer Model (preserved from Bash)

```
Orchestrator (Go binary)
    ↓  writes ACTIVE_TASK.md (briefing)
Agent (claude or any agent_command)
    ↓  writes session file (report)
State Files (tasks.yaml, project-state.yaml)
```

### Agent Contract

The orchestrator requires exactly three things from an agent:

1. A command to invoke (`agent_command` in `doug.yaml`)
2. A pre-created file to read before invocation (`logs/ACTIVE_TASK.md`)
3. A file to write after invocation (the session file, path given in `ACTIVE_TASK.md`)

`ACTIVE_TASK.md` replaces `ACTIVE_BUG.md`, `ACTIVE_FAILURE.md`, and the constructed prompt string from the Bash orchestrator. It contains: task ID, task type, skill instructions for this task type, bug context (if bugfix), and the session file path.

New agent support requires only a new template set — zero orchestrator code changes.

### State Files

| File | Owner | Writes |
|------|-------|--------|
| `tasks.yaml` | User | Orchestrator writes status fields only (TODO → IN_PROGRESS → DONE/BLOCKED) |
| `project-state.yaml` | Orchestrator | Full ownership; loaded once per iteration, mutated in memory, written atomically via `SaveState()` |
| `doug.yaml` | User | Read-only at runtime; CLI flags override at highest precedence |

### Synthetic Tasks

`bugfix` and `documentation` tasks are orchestrator-injected. They never appear in `tasks.yaml`. They live only in `project-state.yaml.active_task` as transient state. This `UserDefined` vs `Synthetic` distinction is a first-class concept in the Go type system.

### Failure Recovery Tiers

| Tier | Behavior | When |
|------|----------|------|
| 1 | Self-correct silently | Unambiguously recoverable, zero risk of death spiral |
| 2 | Self-correct + visible warning | Orchestrator can fix it but the user should know |
| 3 | Exit with clear message | Ambiguous, involves git state, or risks a death spiral |

Before any self-correction: ask "could this same condition re-trigger on the next iteration?" If yes → Tier 3.

---

## Package Structure

```
doug/
├── cmd/
│   ├── run.go          # run subcommand — main orchestration loop
│   └── init.go         # init subcommand — project scaffolding
├── internal/
│   ├── types/          # All shared structs and typed constants
│   ├── state/          # LoadProjectState, SaveProjectState, LoadTasks, SaveTasks
│   ├── config/         # OrchestratorConfig, LoadConfig, DetectBuildSystem
│   ├── log/            # Info, Success, Warning, Error, Fatal, Section
│   ├── build/          # BuildSystem interface, GoBuildSystem, NpmBuildSystem
│   ├── git/            # EnsureEpicBranch, RollbackChanges, Commit
│   ├── orchestrator/   # Bootstrap, TaskPointers, Validation, Startup, LoopContext
│   ├── metrics/        # RecordTaskMetrics, PrintEpicSummary
│   ├── changelog/      # UpdateChangelog
│   ├── agent/          # Session, ActiveTask, Invoke, Parse
│   ├── handlers/       # Success, Failure, Bug, Epic
│   └── templates/      # Embedded template files (//go:embed)
├── integration/
│   └── smoke_test.go   # End-to-end test with mock agent
└── doug.yaml  # Default config (generated by init)
```

---

## Config File (`doug.yaml`)

```yaml
agent_command: claude        # Command used to invoke the agent
build_system: go             # go | npm (auto-detected by init; override here)
max_retries: 5               # Max FAILURE outcomes before a task is BLOCKED
max_iterations: 20           # Max loop iterations before the run exits
kb_enabled: true             # If false, skip KB synthesis task after features complete
```

CLI flags override all config values. A missing config file returns these defaults.

---

## Key Behavioral Decisions

### What changes from the Bash orchestrator

| Change | Reason |
|--------|--------|
| `ACTIVE_TASK.md` replaces `ACTIVE_BUG.md` + `ACTIVE_FAILURE.md` + constructed prompt | Unified dispatch file; clearer agent contract |
| Atomic YAML writes via `os.Rename` | Eliminates partial-write corruption |
| `exec.Command` replaces all `eval "$cmd"` | Eliminates shell injection risk |
| `SessionResult` has exactly 3 fields | Removes dead fields (`estimated_tokens`, `duration_seconds`, etc.) |
| Epic commit failure is a Tier 3 exit | Fixes silent-swallow bug (CI-6) |
| `next_task.type` preserved for synthetic tasks in bug handler | Fixes deadlock bug (CI-5) |
| `logs/ACTIVE_BUG.md` and `logs/ACTIVE_FAILURE.md` paths are canonical | Fixes path mismatch bugs (CI-1, CI-2) |
| `IsInitialized()` for Go checks `go.sum` (same as Bash) | No change — behavior preserved |
| `handle_early_exit` epic-complete check removed | Dead code — nothing ever set this value |
| Python build system not ported | Was a no-op stub; defer to community |

### What does NOT change

- State machine: SUCCESS → verify/commit | BUG → interrupt | FAILURE → retry | EPIC_COMPLETE → finish
- 5-strike retry limit, no workarounds policy
- `feature/{epic_id}` branch naming
- `BUG-{task_id}` bug ID generation
- Attempt counter incremented at the START of each iteration
- Protected paths during rollback: `logs/`, `docs/kb/`, `.env`, `*.backup`, `project-state.yaml`, `tasks.yaml`
- Session file pre-creation pattern (orchestrator creates the file before agent runs)
- Agent boundary is enforced by instruction, not sandboxing (document in README)

---

## Definition of Done

### Per-Epic
- `go build ./...` passes after every task
- `go test ./...` passes after every task

### For the Full Port
- [ ] All 24 feature tasks across Epics 1–6 are DONE
- [ ] `go test ./...` passes with meaningful coverage across `internal/` packages
- [ ] Integration smoke test passes (two-task epic with mock agent, end-to-end)
- [ ] `doug init` produces a usable project scaffold
- [ ] `cmd/run.go` has been human-reviewed after EPIC-5-005
- [ ] Task 6-4 (Final Integration QA) signed off by human reviewer
- [ ] README documents the agent trust boundary explicitly
- [ ] No `sed`, `awk`, `yq`, or `eval` in the codebase

---

## Pre-Epic Checklist (Manual — before running any tasks)

Complete these before creating `tasks.yaml` and starting EPIC-1:

- [ ] Create the Go port repository: `go mod init github.com/[org]/doug`
- [ ] Set up the Bash orchestrator in the repo via `setup.sh`
- [ ] In the Go port project's `CLAUDE.md`, correct the file paths:
  - `logs/bugs/ACTIVE_BUG.md` → `logs/ACTIVE_BUG.md`
  - `logs/failures/ACTIVE_FAILURE.md` → `logs/ACTIVE_FAILURE.md`
- [ ] Add to the feature skill file: agents must run `go mod tidy` before writing session results when adding new Go dependencies
- [ ] Add to the documentation skill file: valid outcomes are SUCCESS and FAILURE only — do NOT report BUG during KB synthesis
- [ ] Set `kb_enabled: false` in `project-state.yaml` — KB synthesis is not needed for a new tool
- [ ] Set `build_system: go` in `doug.yaml`
- [ ] Confirm `go.sum` is committed after EPIC-1-001 before starting EPIC-1-002

---

## Epics

| Epic | Theme | Tasks | Depends On |
|------|-------|-------|------------|
| 1 | Scaffold & Core Types | 4 | — |
| 2 | Infrastructure | 4 | Epic 1 |
| 3 | State Management | 4 | Epics 1–2 |
| 4 | Agent Layer | 4 | Epics 1–2 |
| 5 | Handlers & Main Loop | 5 | Epics 1–4 |
| 6 | Init Subcommand & Templates | 4 | Epic 5 |

**Total**: 25 tasks (24 feature, 1 manual_review)  
**Binary is functionally complete after Epic 5.** Epic 6 is onboarding infrastructure.

---

## Open Items

- [ ] **Tool name in module path**: `github.com/[org]/doug` — replace `[org]` before starting EPIC-1-001
- [ ] **LoopContext ambiguity**: If agents find `*LoopContext` references in Epic 5 tasks ambiguous (it's first defined in EPIC-5-001), consider extracting its definition to a bridging task between Epics 4 and 5
- [ ] **Agent trust boundary**: Document in README that the agent has full filesystem access and the boundary is enforced by instruction only (CLAUDE.md, skill files, .claude/settings.json). Explore sandboxing options for a future version.
