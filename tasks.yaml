epic:
  id: "EPIC-3"
  name: "State Management"
  tasks:
    - id: "EPIC-3-001"
      type: "feature"
      status: "DONE"
      description: "Create internal/orchestrator/bootstrap.go. Implement BootstrapFromTasks(state *types.ProjectState, tasks *types.Tasks) (initializes epic/task pointers on first run), NeedsKBSynthesis(state, tasks) bool, and IsEpicAlreadyComplete(state, tasks) bool. The dead epic-complete task type from the Bash orchestrator is NOT ported — IsEpicAlreadyComplete checks task completion status directly."
      acceptance_criteria:
        - "BootstrapFromTasks is a no-op if state.CurrentEpic.ID is already set"
        - "On first run, populates current_epic (id, name, branch_name, started_at), active_task (first task), and next_task (second task or empty)"
        - "NeedsKBSynthesis returns false if any tasks remain TODO/IN_PROGRESS, if kb_enabled is false, or if active task is already documentation type"
        - "IsEpicAlreadyComplete returns true only when all user-defined tasks are DONE and kb_enabled is false, or kb synthesis is also complete"
        - "Unit tests cover: fresh state, already-bootstrapped state, single-task epic, kb_enabled=false"
    - id: "EPIC-3-002"
      type: "feature"
      status: "DONE"
      description: "Create internal/orchestrator/taskpointers.go. Implement InitializeTaskPointers(state, tasks), AdvanceToNextTask(state, tasks) bool, FindNextActiveTask(tasks) (id, taskType string), IncrementAttempts(state), and UpdateTaskStatus(tasks, id, status)."
      acceptance_criteria:
        - "InitializeTaskPointers selects IN_PROGRESS task first, then TODO; sets synthetic KB_UPDATE task if no feature tasks remain and kb_enabled is true"
        - "AdvanceToNextTask promotes next_task to active_task, finds the new next_task (or empty), returns false if no more tasks remain"
        - "IncrementAttempts increments state.ActiveTask.Attempts in memory (caller is responsible for SaveState)"
        - "UpdateTaskStatus finds the task by ID in tasks.Tasks and updates its Status; returns an error if ID not found"
        - "Unit tests cover: advance through 3 tasks, advance from last task (no next), KB synthesis trigger, UpdateTaskStatus with unknown ID"
    - id: "EPIC-3-003"
      type: "feature"
      status: "TODO"
      description: "Create internal/orchestrator/validation.go. Implement ValidateYAMLStructure(state, tasks) error and ValidateStateSync(state, tasks) (ValidationResult, error). Apply the tiered recovery philosophy: unambiguous recovery is silent, recoverable-with-risk emits a warning, ambiguous cases return an error."
      acceptance_criteria:
        - "ValidateYAMLStructure returns an error for missing required fields (current_epic.id, active_task.type, active_task.id) and invalid task status enum values"
        - "ValidateStateSync silently corrects state when active_task.ID is not found in tasks.yaml AND there is exactly one TODO/IN_PROGRESS task to redirect to"
        - "ValidateStateSync returns a warning-level ValidationResult (not error) when it auto-corrects, so the caller can log it"
        - "ValidateStateSync returns an error when the mismatched ID belongs to a synthetic task type (bugfix, documentation) — no auto-correct for synthetic tasks"
        - "ValidationResult type distinguishes: OK, AutoCorrected (with description), and Fatal"
    - id: "EPIC-3-004"
      type: "feature"
      status: "TODO"
      description: "Create internal/metrics/metrics.go and internal/changelog/changelog.go. Metrics: RecordTaskMetrics, UpdateMetricTotals, PrintEpicSummary. Changelog: UpdateChangelog(path, entry, taskType string) reads the file, finds the correct section header, splices in the new entry, and writes back. Includes deduplication check before inserting."
      acceptance_criteria:
        - "RecordTaskMetrics appends to state.Metrics.Tasks and calls UpdateMetricTotals; metric errors are non-fatal (logged as warning, do not fail the task)"
        - "PrintEpicSummary prints a box-draw table with total tasks, total time (formatted as h/m/s), and average time per task"
        - "UpdateChangelog returns a non-fatal error (logged as warning) if the section header is not found, rather than crashing"
        - "UpdateChangelog is idempotent: inserting the same entry twice results in only one entry in the file"
        - "UpdateChangelog uses pure Go string manipulation — no sed, no awk, no exec.Command"
