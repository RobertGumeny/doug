epic:
  id: "EPIC-4"
  name: "Agent Layer"
  tasks:
    - id: "EPIC-4-001"
      type: "feature"
      status: "DONE"
      description: "Create internal/agent/session.go. Implement CreateSessionFile(logsDir, epic, taskID string, attempt int) (string, error): copies the embedded session results template to logs/sessions/{epic}/session-{taskID}_attempt-{attempt}.md and pre-fills the task_id field. Session file path construction and template hydration are the only responsibilities of this function."
      acceptance_criteria:
        - "Session file path follows the exact pattern logs/sessions/{epic}/session-{taskID}_attempt-{attempt}.md"
        - "The template task_id field is pre-filled with the actual task ID at creation time"
        - "CreateSessionFile creates the parent directory if it does not exist"
        - "Unit test verifies file creation, task_id injection, and that the rest of the template structure is preserved"
    - id: "EPIC-4-002"
      type: "feature"
      status: "DONE"
      description: "Create internal/agent/activetask.go. Implement WriteActiveTask(config ActiveTaskConfig) error which writes logs/ACTIVE_TASK.md with: task ID, task type, skill instructions (loaded from skills-config.yaml mapping), session file path, and bug context section (bugfix tasks only). Implement GetSkillForTaskType(taskType, configPath string) (string, error) reading from skills-config.yaml with hardcoded fallback defaults."
      acceptance_criteria:
        - "ACTIVE_TASK.md is always written to logs/ACTIVE_TASK.md — overwritten each iteration, never archived"
        - "Skill instructions are loaded from the resolved skill file path in skills-config.yaml, or from hardcoded fallback content if the file is missing"
        - "For bugfix tasks, the bug context section reads from logs/ACTIVE_BUG.md; if the file is missing, the section is omitted gracefully with a warning log"
        - "For documentation (synthetic) tasks, the task type is preserved correctly as 'documentation' in the written file"
        - "GetSkillForTaskType returns an error for unknown task types with no fallback"
    - id: "EPIC-4-003"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/invoke.go. Implement RunAgent(agentCommand, projectRoot string) (time.Duration, error): parse agentCommand by whitespace into executable + args slice (no sh -c), create exec.Cmd with Dir=projectRoot, pipe Stdout and Stderr to the parent process in real time, record wall-clock duration. Block until the agent exits."
      acceptance_criteria:
        - "Agent command is split by whitespace into executable + args slice — no sh -c or shell wrapping of any kind"
        - "cmd.Stdout and cmd.Stderr are wired to the parent process's os.Stdout and os.Stderr so agent output is visible live"
        - "Duration is measured from immediately before cmd.Start() to cmd.Wait() completion"
        - "A non-zero exit code from the agent returns an error with the exit code included in the message"
        - "An empty or whitespace-only agentCommand returns a validation error before attempting exec"
    - id: "EPIC-4-004"
      type: "feature"
      status: "TODO"
      description: "Create internal/agent/parse.go. Implement ParseSessionResult(filePath string) (*types.SessionResult, error): read the session file, extract YAML frontmatter between the first and second --- delimiter lines, unmarshal into SessionResult, validate that Outcome is one of the four valid values. No awk, no yq — pure Go string scanning and yaml.Unmarshal."
      acceptance_criteria:
        - "Frontmatter extraction handles both Windows (CRLF) and Unix (LF) line endings"
        - "Returns a typed error distinguishing: file not found, no frontmatter found, missing outcome field, invalid outcome value"
        - "All four valid outcomes (SUCCESS, BUG, FAILURE, EPIC_COMPLETE) are accepted; anything else is an error"
        - "Extra fields in the frontmatter beyond the three consumed fields are silently ignored"
        - "Table-driven unit tests cover: valid file, missing ---, empty outcome, unknown outcome value, extra fields"
